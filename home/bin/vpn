#!/bin/bash

#set -x
set -e

COMMAND=$1
VPN_CONF=${2:-ocrolus}
VPN_SERVICE="openvpn@${VPN_CONF}.service"

case $COMMAND in
  start)
    sudo systemctl stop systemd-ask-password-wall.path
    sudo systemctl stop systemd-ask-password-wall.service

    sudo systemctl start $VPN_SERVICE

    sudo systemd-tty-ask-password-agent --query
    sudo systemd-tty-ask-password-agent --query

    tailf -1 /var/log/syslog | grep --color --max-count=1 \
      "ovpn-$VPN_CONF\[[[:digit:]]\+\]: \(TUN/TAP device tun[[:digit:]] opened\|AUTH: Received control message: AUTH_FAILED\)"

    sudo systemctl start systemd-ask-password-wall.path
    ;;
  stop)
    sudo systemctl stop $VPN_SERVICE
    ;;
  restart)
    $0 stop
    $0 start
    ;;
  stats)
    $0 logs &
    TAILF_PID=$(ps --ppid=$! --no-headers -o pid -o comm | grep tailf$ | cut -d ' ' -f 1)

    sudo systemctl kill --signal=USR2 $VPN_SERVICE

    kill $TAILF_PID
    exit 0
    ;;
  logs)
    tailf /var/log/syslog | grep $VPN_CONF
    exit 0
    ;;
esac

sudo systemctl status $VPN_SERVICE | sed -ne "/^\s*Active:/ { s,^\s\+,,; p; }"
ifconfig -s | grep ^tun
